<!-- 
Author: Anna Ni (annani@bu.edu)
File: show_profile.html
Description: Template for displaying a single user profile in Mini Insta.
-->

{% extends 'mini_insta/base.html' %}

{% block content %}
  <div style="display:flex; gap:2rem; align-items:flex-start;">
    <div>
      {% if profile.profile_image_url %}
        <img src="{{ profile.profile_image_url }}" alt="{{ profile.username }}" 
             style="width:240px;height:240px;object-fit:cover;border-radius:12px;">
      {% else %}
        <div style="width:240px;height:240px;border-radius:12px;background:#ddd;
                    display:flex;align-items:center;justify-content:center;">
          No image
        </div>
      {% endif %}
    </div>

    <div>
      <h2>{{ profile.display_name }}</h2>
      <p style="margin:0;color:#666">@{{ profile.username }}</p>
      <p style="margin-top:1rem;">{{ profile.bio_text }}</p>
      <p style="color:#888;font-size:0.9rem;margin-top:1rem;">
        Joined: {{ profile.join_date }}
      </p>

      <!-- Follow/Unfollow Button (only show if user is authenticated and not viewing own profile) -->
      {% if request.user.is_authenticated and user_profile %}
        {% if request.user != profile.user %}
          {% if user_profile in profile.get_followers %}
            <a href="{% url 'mini_insta:unfollow' profile.pk %}" 
               style="display:inline-block; margin-top:1rem; padding:0.5rem 1.5rem; background:#dc3545; color:white; text-decoration:none; border-radius:6px;">
              Unfollow
            </a>
          {% else %}
            <a href="{% url 'mini_insta:follow' profile.pk %}" 
               style="display:inline-block; margin-top:1rem; padding:0.5rem 1.5rem; background:#007bff; color:white; text-decoration:none; border-radius:6px;">
              Follow
            </a>
          {% endif %}
        {% endif %}
      {% endif %}

      <!-- Followers, Following, Posts stats -->
      <div style="margin-top:1.5rem; padding:0.8rem; border:1px solid #eee; border-radius:6px;">
        <p style="margin:0.5rem 0;">
          <strong>Followers:</strong> 
          <a href="{% url 'mini_insta:show_followers' profile.pk %}" 
             style="color:#007bff; text-decoration:none;">
            {{ profile.get_num_followers }}
          </a>
        </p>
        <p style="margin:0.5rem 0;">
          <strong>Following:</strong> 
          <a href="{% url 'mini_insta:show_following' profile.pk %}" 
             style="color:#007bff; text-decoration:none;">
            {{ profile.get_num_following }}
          </a>
        </p>
        <p style="margin:0.5rem 0;">
          <strong>Posts:</strong> {{ profile.get_all_posts.count }}
        </p>
      </div>
    </div>
  </div>

  <!-- : Posts section -->
  <div style="margin-top:2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2>Posts</h2>
      <!-- Only show Feed link if viewing own profile -->
      {% if request.user.is_authenticated and request.user == profile.user %}
        <a href="{% url 'mini_insta:show_feed' profile.pk %}" 
           style="padding:0.5rem 1rem; background:#17a2b8; color:white; text-decoration:none; border-radius:6px;">
          üè† View Feed
        </a>
      {% endif %}
    </div>
  
    <!-- Edit Profile and Create Post - only show if viewing own profile -->
    {% if request.user.is_authenticated and request.user == profile.user %}
      <p>
        <a href="{% url 'mini_insta:update_profile' profile.pk %}" 
           style="padding:0.5rem 1rem; background:#28a745; color:white; border-radius:6px; text-decoration:none;">
          ‚úèÔ∏è Edit Profile
        </a>
      </p>
      
      <p>
        <a href="{% url 'mini_insta:create_post' profile.pk %}" 
           style="padding:0.5rem 1rem; background:#007bff; color:white; text-decoration:none; border-radius:6px;">
          + Create New Post
        </a>
      </p>
    {% endif %}

    {% for post in profile.get_all_posts %}
      <div style="border:1px solid #eee; padding:1rem; margin-bottom:1rem; border-radius:8px;">
        <p style="margin:0 0 0.5rem 0;"><em>{{ post.timestamp }}</em></p>
        <p>{{ post.caption }}</p>
        
        <!-- Fixed: Use post.photos.all and get_image_url() method -->
        {% if post.photos.all %}
          <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
            {% for photo in post.photos.all %}
              <img src="{{ photo.get_image_url }}" alt="Post photo" 
                   style="width:300px; height:auto; border-radius:8px;">
            {% endfor %}
          </div>
        {% elif post.image_url %}
          <!-- Fallback for old posts with image_url on Post model -->
          <img src="{{ post.image_url }}" alt="Post photo" 
               style="width:300px; height:auto; border-radius:8px;">
        {% else %}
          <div style="width:300px; height:200px; background:#ddd; 
                      display:flex; align-items:center; justify-content:center;
                      border-radius:8px;">
            No image available
          </div>
        {% endif %}

        <!-- Link to PostDetailView -->
        <p><a href="{% url 'mini_insta:show_post' post.pk %}">View Post Details ‚Üí</a></p>
      </div>
    {% empty %}
      <p>No posts yet.</p>
    {% endfor %}
  </div>
{% endblock %}